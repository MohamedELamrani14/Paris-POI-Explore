<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1, width=device-width, maximum-scale=1">
  <title>Paris POI Explorer ‚Äî √©coles, h√¥pitaux, caf√©s</title>

  <!-- Leaflet + styles qgis2web existants -->
  <link rel="stylesheet" href="css/leaflet.css">
  <link rel="stylesheet" href="css/fontawesome-all.min.css">
  <link rel="stylesheet" href="css/leaflet.photon.css">

  <!-- Design minimal -->
  <style>
    :root{
      --bg:#0f172a; --panel:#0b1220; --text:#e2e8f0; --muted:#94a3b8; --accent:#22c55e;
      --chip:#1f2937; --border:#1e293b; --card:#111827;
    }
    html,body{height:100%; margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; background:var(--bg); color:var(--text);}
    .app{display:grid; grid-template-rows:auto 1fr; height:100%;}
    header{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 18px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,#0f172a,#0b1220);
    }
    header .title{display:flex; gap:10px; align-items:center; font-weight:700; letter-spacing:.2px}
    header .title span.badge{font-size:12px; background:var(--chip); padding:4px 8px; border-radius:999px; color:var(--muted)}
    header .actions{display:flex; gap:10px; align-items:center}
    .btn{
      background:var(--chip); color:var(--text); border:1px solid var(--border);
      padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600
    }
    .btn:hover{filter:brightness(1.1)}
    .layout{display:grid; grid-template-columns:360px 1fr; height:100%;}
    #panel{
      background:var(--panel); border-right:1px solid var(--border); padding:16px; overflow:auto;
    }
    #panel h2{font-size:16px; margin:6px 0 12px; color:#fff}
    #panel p{color:var(--muted); margin:0 0 10px}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; margin-bottom:12px;
    }
    .row{display:flex; gap:8px}
    .field{flex:1}
    input[type="text"]{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
      background:#0a1020; color:var(--text); outline:none;
    }
    .chips{display:flex; flex-wrap:wrap; gap:6px; margin-top:8px}
    .chip{background:var(--chip); padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid var(--border)}
    .kpi{display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:10px}
    .kpi .box{background:#0a1020; border:1px solid var(--border); border-radius:12px; padding:10px}
    .kpi .box .num{font-size:20px; font-weight:800}
    #map{height:100%}
    .list{display:grid; gap:8px; margin-top:8px}
    .item{padding:8px; border:1px solid var(--border); border-radius:10px; background:#0a1020}
    .muted{color:var(--muted)}
    .legend{display:flex; gap:8px; flex-wrap:wrap}
    .dot{width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px}
    .dot.cafe{background:#e5b636}
    .dot.hospital{background:#f01944}
    .dot.school{background:#7d8b8f}
    /* light mode */
    .light{--bg:#f8fafc; --panel:#ffffff; --text:#0f172a; --muted:#475569; --chip:#eef2ff; --border:#e2e8f0; --card:#ffffff}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        <span>üó∫Ô∏è Paris POI Explorer</span>
        <span class="badge">√©coles ¬∑ h√¥pitaux ¬∑ caf√©s</span>
        <span class="badge">assistant</span>
      </div>
      <div class="actions">
        <button id="themeBtn" class="btn">‚òÄÔ∏è/üåô Th√®me</button>
        <button id="viewSummaryBtn" class="btn">R√©sum√© de la vue</button>
        <button id="nearestCenterBtn" class="btn">Plus proche (centre carte)</button>
      </div>
    </header>

    <div class="layout">
      <aside id="panel">
        <div class="card">
          <h2>Assistant</h2>
          <p>Pose (choisi) une question; Tout est calcul√© <b>localement</b> </p>
          <div class="row">
            <input id="ask" type="text" placeholder="ex : caf√©s √† 500 m de la tour Eiffel">
            <button id="askBtn" class="btn">OK</button>
          </div>
          <div class="chips">
            <span class="chip">compter dans la vue</span>
            <span class="chip">top 10 caf√©s proches</span>
            <span class="chip">√©coles √† 1 km d‚Äôune adresse</span>
          </div>
          <div class="kpi">
            <div class="box"><div class="muted">Caf√©s</div><div id="kpiCafes" class="num">‚Äì</div></div>
            <div class="box"><div class="muted">H√¥pitaux</div><div id="kpiHospitals" class="num">‚Äì</div></div>
            <div class="box"><div class="muted">√âcoles</div><div id="kpiSchools" class="num">‚Äì</div></div>
          </div>
        </div>

        <div class="card">
          <h2>Filtres & l√©gende</h2>
          <div class="legend">
            <label><input type="checkbox" id="cbCafes" checked> <span class="dot cafe"></span> Caf√©s</label>
            <label><input type="checkbox" id="cbHospitals" checked> <span class="dot hospital"></span> H√¥pitaux</label>
            <label><input type="checkbox" id="cbSchools" checked> <span class="dot school"></span> √âcoles</label>
          </div>
        </div>

        <div class="card">
          <h2>R√©sultats</h2>
          <div id="results" class="list"></div>
        </div>

        <p class="muted">¬© OpenStreetMap ¬∑ Carte g√©n√©r√©e depuis QGIS/qgis2web</p>
      </aside>

      <main id="map"></main>
    </div>
  </div>

  <!-- libs qgis2web export -->
  <script src="js/leaflet.js"></script>
  <script src="js/leaflet.photon.js"></script>
  <script src="js/Autolinker.min.js"></script>

  <!-- nos donn√©es export√©es (gard√©es telles quelles) -->
  <script src="data/cafes_paris_1.js"></script>
  <script src="data/hospitals_paris_2.js"></script>
  <script src="data/schools_paris_3.js"></script>

  <!-- Turf.js pour les calculs g√©ospatiaux -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script>
    // --- Th√®me clair/sombre ---
    const themeBtn = document.getElementById('themeBtn');
    themeBtn.addEventListener('click', ()=> document.body.classList.toggle('light'));

    // --- Init carte ---
    const map = L.map('map', { zoomControl: true }).setView([48.8566, 2.3522], 12);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // --- Styles ---
    const styleCafe = { radius:5, color:'#232323', weight:1, fill:true, fillOpacity:1, fillColor:'#e5b636' };
    const styleHospital = { radius:5, color:'#232323', weight:1, fill:true, fillOpacity:1, fillColor:'#f01944' };
    const styleSchool = { radius:5, color:'#232323', weight:1, fill:true, fillOpacity:1, fillColor:'#7d8b8f' };

    // --- Cr√©e feuilles depuis json_* (variables fournies par qgis2web) ---
    const cafes = L.geoJSON(json_cafes_paris_1, {
      pointToLayer: (f, latlng)=> L.circleMarker(latlng, styleCafe),
      onEachFeature: (f,l)=> l.bindPopup(`<b>${f.properties.name||'Sans nom'}</b><br>Caf√©<br>${f.properties['addr:street']||''}`)
    }).addTo(map);
    const hospitals = L.geoJSON(json_hospitals_paris_2, {
      pointToLayer: (f, latlng)=> L.circleMarker(latlng, styleHospital),
      onEachFeature: (f,l)=> l.bindPopup(`<b>${f.properties.name||'Sans nom'}</b><br>H√¥pital<br>${f.properties['addr:street']||''}`)
    }).addTo(map);
    const schools = L.geoJSON(json_schools_paris_3, {
      pointToLayer: (f, latlng)=> L.circleMarker(latlng, styleSchool),
      onEachFeature: (f,l)=> l.bindPopup(`<b>${f.properties.name||'Sans nom'}</b><br>√âcole<br>${f.properties['addr:street']||''}`)
    }).addTo(map);

    const groups = { cafes, hospitals, schools };

    // --- Filtres checkbox ---
    const bindToggle = (id, layer)=> {
      const cb = document.getElementById(id);
      const sync = ()=> cb.checked ? map.addLayer(layer) : map.removeLayer(layer);
      cb.addEventListener('change', sync); sync();
    };
    bindToggle('cbCafes', cafes);
    bindToggle('cbHospitals', hospitals);
    bindToggle('cbSchools', schools);

    // --- KPI "dans la vue" ---
    function countInView(layer){
      let n=0; layer.eachLayer(l=> { if(map.getBounds().contains(l.getLatLng())) n++; });
      return n;
    }
    function updateKPIs(){
      document.getElementById('kpiCafes').textContent = countInView(cafes);
      document.getElementById('kpiHospitals').textContent = countInView(hospitals);
      document.getElementById('kpiSchools').textContent = countInView(schools);
    }
    map.on('moveend', updateKPIs);
    updateKPIs();

    // --- utils pour lister des features tri√©es par distance ---
    function featuresArray(layer){
      const arr=[]; layer.eachLayer(l=>{
        const f = l.feature;
        const c = l.getLatLng();
        arr.push({ f, lat:c.lat, lng:c.lng, name: f.properties.name||'Sans nom' });
      }); return arr;
    }
    const CAFES = featuresArray(cafes);
    const HOSPS = featuresArray(hospitals);
    const SCHOOLS = featuresArray(schools);

    function nearest(from, pool, limit=10){
      const origin = turf.point([from.lng, from.lat]);
      const scored = pool.map(p=>{
        const d = turf.distance(origin, turf.point([p.lng, p.lat]), {units:'kilometers'});
        return {...p, km:d};
      }).sort((a,b)=>a.km-b.km).slice(0,limit);
      return scored;
    }

    function renderResults(title, list){
      const el = document.getElementById('results');
      el.innerHTML = `<div class="muted">${title}</div>` + list.map(item=>{
        return `<div class="item"><b>${item.name}</b><br><span class="muted">${item.km ? item.km.toFixed(2)+' km' : ''}</span></div>`;
      }).join('');
    }

    // --- Boutons rapides ---
    document.getElementById('viewSummaryBtn').addEventListener('click', ()=>{
      updateKPIs();
      renderResults('R√©sum√© de la vue (dans l‚Äô√©cran actuel)', []);
    });

    document.getElementById('nearestCenterBtn').addEventListener('click', ()=>{
      const c = map.getCenter();
      const list = [
        ...nearest(c, CAFES, 5).map(x=>({...x, type:'cafe'})),
        ...nearest(c, HOSPS, 5).map(x=>({...x, type:'hospital'})),
        ...nearest(c, SCHOOLS, 5).map(x=>({...x, type:'school'})),
      ].sort((a,b)=>a.km-b.km).slice(0,10);
      renderResults('Top 10 POI les plus proches du centre de la carte', list);
      L.marker(c).addTo(map).bindPopup('Centre actuel').openPopup();
    });

    // --- Recherche d‚Äôadresse (Photon) + logique "IA style" simple ---
    const ask = document.getElementById('ask'); 
    const askBtn = document.getElementById('askBtn');

    // Petit parseur d‚Äôintentions tr√®s simple (mots-cl√©s)
    function parseQuery(q){
      q = q.toLowerCase();
      const radius = /(\d+)\s*(m|km)/.exec(q);
      let distKm = 1; // d√©faut 1 km
      if(radius){
        const val = parseFloat(radius[1]);
        distKm = radius[2]==='m' ? val/1000 : val;
      }
      const want = {
        cafes: /caf√©|cafes|caf√©s/.test(q),
        hospitals: /h√¥pital|hopital|hospitals?/.test(q),
        schools: /√©cole|ecole|schools?/.test(q)
      };
      // si aucun type mentionn√© ‚Üí tous
      if(!want.cafes && !want.hospitals && !want.schools){
        want.cafes = want.hospitals = want.schools = true;
      }
      return {distKm, want};
    }

    async function geocode(address){
      return new Promise((resolve,reject)=>{
        // Utilise le provider Photon (d√©j√† inclus via leaflet.photon)
        const ctrl = L.control.photon({ placeholder: 'Rechercher‚Ä¶', position:'topleft' });
        // Hack: on fait une requ√™te ‚Äúfant√¥me‚Äù via l‚ÄôAPI interne du contr√¥le
        ctrl._search(address, (results)=>{
          if(results && results.features && results.features[0]){
            const f = results.features[0];
            resolve({lat:f.geometry.coordinates[1], lng:f.geometry.coordinates[0], label:f.properties.label});
          } else reject('Adresse introuvable');
        });
      });
    }

    askBtn.addEventListener('click', async ()=>{
      const q = ask.value.trim();
      if(!q){ return; }
      const { distKm, want } = parseQuery(q);

      // Essaie d‚Äôextraire une adresse : tout ce qui suit ‚Äúde‚Äù ou ‚Äúpr√®s de‚Äù
      const m = /(?:de|pr√®s de|pres de|around|near)\s+(.+)$/i.exec(q);
      let center = map.getCenter(), label='centre de la carte';
      if(m && m[1]){
        try{
          const g = await geocode(m[1]);
          center = L.latLng(g.lat, g.lng);
          label = g.label;
          L.marker(center).addTo(map).bindPopup('üìç ' + label).openPopup();
          map.setView(center, 14);
        }catch(e){ /* garde le centre courant */ }
      }

      const pools = [];
      if(want.cafes) pools.push(...nearest(center, CAFES, 100));
      if(want.hospitals) pools.push(...nearest(center, HOSPS, 100));
      if(want.schools) pools.push(...nearest(center, SCHOOLS, 100));
      const within = pools.filter(x=> x.km <= distKm).sort((a,b)=>a.km-b.km).slice(0,20);

      renderResults(`POI √† moins de ${distKm} km de ${label}`, within);
    });

    // clic sur un chip remplit la question
    document.querySelectorAll('.chip').forEach(ch=>{
      ch.addEventListener('click', ()=> { ask.value = ch.textContent; });
    });
  </script>
</body>
</html>
